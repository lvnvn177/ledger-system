

## DB

UserAccount 
- ID
- 사용자 이름
- 잔액
- 포트폴리오


Position
- ID
- 보유한 유저 (N:1)
- 티커 
- 수량
- 평균 매수가 

Orer
- ID
- 주문한 유저 (N:1)
- 티커 
- 수량 
- 주문 방향(매수/매도)
- 가격 (주문 당시)
- 주문 상태 
- 주문한 시각 


TransactionHistory
- ID
- 거래한 유저 ID
- 해당 유저가 주문한 리스트 
- 현재 거래 상태
- 거래 일시 


LedgerEntry
- ID
- entryId, 해당 항목과 관련된 거래 또는 다른 액션 항목 ID 
- 해당 유저 ID
- 주문 ID, IF 주문에 관련된 원장이라면? 
- LedgerEntryType, 어떤 기록인지 
- 자산 티커 
- 금액
- 해당 기록 일시 


Event
- ID
- 이벤트 고유 ID
- 이벤트 타입
- 관련 이벤트 ID
- 이벤트 버전 
- 이벤트 발생 시각
- 이벤트 관련 데이터
- 메타 데이터 
- 이벤트를 발생시킨 유저 ID 










------



### `LedgerEntry`와 `Event`의 핵심 차이: "결과" vs "과정"

-   **`LedgerEntry` (원장 기록)**: **회계적인 '결과'**를 기록합니다. 즉, 돈과 자산이 **어떻게 변했는지**에 대한 최종 상태를 기록하는 **회계 장부**입니다.
-   **`Event` (이벤트)**: 그 결과가 만들어지기까지의 **모든 '과정(사건)'**을 기록합니다. 사용자의 모든 클릭, 시스템의 모든 상호작용 하나하나를 기록하는 **행동 로그** 또는 **CCTV 영상**과 같습니다.

---

### 원장 시스템을 통한 비유 설명

"사용자 A가 SPY 주식 10주를 100달러에 매수했다"는 상황을 가정해 보겠습니다.

#### 1. 사건의 발생 (The Event)

가장 먼저 발생하는 것은 "사용자가 매수 주문을 했다"는 **사건**입니다.

-   **`Event` 기록**:
    -   `eventType`: `ORDER_CREATED` (주문 생성됨)
    -   `eventData`: `{ "userId": "A", "asset": "SPY", "quantity": 10, "price": 100, "side": "BUY" }`
    -   `timestamp`: `2023-10-27 10:00:00`

이 `Event`는 "10시에 A라는 사용자가 이런 조건으로 매수 주문을 했어"라는 **사실 그 자체**를 기록합니다. 아직 돈이나 주식에는 아무런 변화가 없습니다.

#### 2. 주문 처리 및 체결

시스템은 이 `ORDER_CREATED` 이벤트를 받아 주문을 처리합니다. 잠시 후, 이 주문이 시장에서 성공적으로 체결되었다고 가정합시다.

-   **`Event` 기록**:
    -   `eventType`: `ORDER_COMPLETED` (주문 체결됨)
    -   `eventData`: `{ "orderId": "주문123", "status": "COMPLETED", "filledPrice": 100.5 }`
    -   `timestamp`: `2023-10-27 10:00:05`

이 `Event`는 "10시 5초에 '주문123'이 100.5달러에 체결되었어"라는 **두 번째 사건**을 기록합니다.

#### 3. 회계 장부 기록 (The Ledger Entry)

이제 주문이 체결되었으므로, 시스템은 **실제로 돈과 자산을 움직여야 합니다.** 이것이 바로 **원장 시스템**이 동작하는 시점이며, 이 결과가 `LedgerEntry`로 기록됩니다.

-   **`LedgerEntry` 기록 1 (현금 출금)**:
    -   `type`: `TRADE_BUY`
    -   `userId`: "A"
    -   `amount`: **-1005.00** (10주 \* 100.5달러)
    -   `description`: "SPY 10주 매수에 따른 현금 차감"

-   **`LedgerEntry` 기록 2 (자산 입고)**:
    -   *이 부분은 설계에 따라 다릅니다. 어떤 시스템은 자산의 변동도 별도의 `LedgerEntry`로 기록하고, 어떤 시스템은 `Position` 테이블의 수량만 변경합니다. 만약 기록한다면 아래와 같을 것입니다.*
    -   `type`: `ASSET_IN`
    -   `userId`: "A"
    -   `assetTicker`: `SPY`
    -   `amount`: **+10** (10주)
    -   `description`: "SPY 10주 매수에 따른 자산 입고"

이 `LedgerEntry`들은 "결과적으로 A의 계좌에서 1005달러가 빠져나갔고, SPY 주식 10주가 들어왔다"는 **회계적 사실**을 명확하게 기록합니다.

### 비유를 통한 최종 정리

| 구분          | `LedgerEntry` (원장)                                                              | `Event` (이벤트)                                                                                |
| ------------- | --------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **역할**      | **은행 통장 거래 내역**, **가계부**                                               | **CCTV 영상**, **모든 행동을 기록한 일기장**                                                    |
| **기록 대상** | 돈과 자산의 **최종적인 증감 결과**                                                | 그 결과가 나오기까지의 **모든 발생 사건**                                                       |
| **관점**      | **회계적 관점** (그래서 얼마가 변했는데?)                                         | **행위적 관점** (그래서 무슨 일이 있었는데?)                                                    |
| **불변성**    | **절대 불변.** 한 번 기록되면 절대 수정하거나 삭제해서는 안 됨. (수정 시에는 반대 एंट्री를 생성) | **절대 불변.** 발생한 사건은 바꿀 수 없음.                                                      |
| **주요 용도** | **자산/부채/잔고 계산**, **재무 감사**, **거래 증명**                               | **시스템 상태 복구**, **사용자 행동 분석**, **버그 추적 및 디버깅**, ** MSA 간 데이터 동기화** |

